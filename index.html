<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scan Sampah AI</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#e0f2f1;
    text-align:center;
}
.container{
    background:white;
    max-width:420px;
    margin:30px auto;
    padding:20px;
    border-radius:12px;
    box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
video{
    width:100%;
    border-radius:10px;
    margin-top:10px;
}
button{
    margin-top:15px;
    padding:12px 20px;
    border:none;
    background:#009688;
    color:white;
    font-size:16px;
    border-radius:6px;
}
.hidden{display:none;}
#hasil{margin-top:15px;font-size:18px;}
</style>
</head>

<body>

<div class="container">
    <h1>â™»ï¸ Scan Sampah AI</h1>
    <p>Pilah sampah organik & anorganik</p>

    <button id="toggleBtn" onclick="toggleScan()">ğŸ“· Buka Scan</button>

    <div id="cameraArea" class="hidden">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>

        <button id="scanBtn" onclick="scanSampah()" disabled>ğŸ” Scan Sampah</button>

        <div id="hasil">ğŸ”’ Scan belum dibuka</div>
    </div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const hasil = document.getElementById("hasil");
const cameraArea = document.getElementById("cameraArea");
const toggleBtn = document.getElementById("toggleBtn");
const scanBtn = document.getElementById("scanBtn");

let model;
let stream = null;

// ================= PRELOAD AI =================
window.addEventListener("load", async () => {
    hasil.innerHTML = "â³ Menyiapkan AI...";
    model = await mobilenet.load();
    hasil.innerHTML = "AI siap silahkan scan";
});

// ================= TOGGLE SCAN =================
async function toggleScan(){
    if(stream === null){
        cameraArea.classList.remove("hidden");
        toggleBtn.disabled = true;
        hasil.innerHTML = "â³ Mengaktifkan kamera...";

        try{
            stream = await navigator.mediaDevices.getUserMedia({
                video:{ facingMode:"environment" }
            });

            video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = r);

            hasil.innerHTML = "Kamera aktif. Menunggu AI siap.";
            toggleBtn.innerHTML = "âŒ Tutup Scan";
            scanBtn.disabled = false;
            toggleBtn.disabled = false;

        }catch(err){
            hasil.innerHTML = "âŒ Gagal membuka kamera";
            toggleBtn.disabled = false;
        }

    }else{
        stream.getTracks().forEach(t => t.stop());
        video.srcObject = null;
        stream = null;

        cameraArea.classList.add("hidden");
        toggleBtn.innerHTML = "ğŸ“· Buka Scan";
        hasil.innerHTML = "ğŸ”’ Scan ditutup";
        scanBtn.disabled = true;
    }
}

// ================= SCAN SAMPAH CERDAS =================
async function scanSampah(){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0);

    const predictions = await model.classify(canvas, 5);

    const kategoriMap = [
        { nama: "Tumbuhan (Plants)", jenis: "Organik",
          kata: ["flower","plant","leaf","tree","grass", "stick", "bamboo"] },
        { nama: "Buah (Fruits)", jenis: "Organik",
          kata: ["grape","fruit","banana","apple","orange", "melon", "watermelon", "mango", "coconut"] },
          { nama: "Sayur (vegetables)", jenis: "Organik",
          kata: ["vegetable","carrot","tomato","potato", "spinach", "eggplant", "salad", "onion", "garlic"] },
        { nama: "Makanan (Food)", jenis: "Organik",
          kata: ["food","bread","meat","rice","cake","pizza", "sausage", "egg", "oat", "chicken"] },
        { nama: "Plastik", jenis: "Anorganik",
          kata: ["plastic","bottle","bag","cup","wrapper","packet","pouch","container"] },
        { nama: "Logam / Kaleng", jenis: "Anorganik",
          kata: ["can","tin","metal","aluminum", "iron"] },
        { nama: "Kaca", jenis: "Anorganik",
          kata: ["glass","jar", "glass bottle"] },
        { nama: "Kertas", jenis: "Anorganik",
          kata: ["paper","cardboard","book","newspaper"] },
        { nama: "Elektronik", jenis: "Anorganik",
          kata: ["mouse", "keyboard", "handphone", "cable", "computer", "motherboard"]
        }
    ];

    let skorKategori = {};

    predictions.forEach(pred => {
        const objek = pred.className.toLowerCase();
        kategoriMap.forEach(k => {
            k.kata.forEach(kata => {
                if(objek.includes(kata)){
                    skorKategori[k.nama] = (skorKategori[k.nama] || 0) + 1;
                }
            });
        });
    });

    let kategoriDitemukan = "Tidak diketahui";
    let jenisSampah = "Tidak diketahui";
    let skorTertinggi = 0;

    kategoriMap.forEach(k => {
        if((skorKategori[k.nama] || 0) > skorTertinggi){
            skorTertinggi = skorKategori[k.nama];
            kategoriDitemukan = k.nama;
            jenisSampah = k.jenis;
        }
    });

    const objekUtama = predictions[0].className;
    const conf = (predictions[0].probability * 100).toFixed(2);

    hasil.style.color = jenisSampah === "Organik" ? "green" : "blue";

    hasil.innerHTML = `
        ğŸ” <b>Objek Terdeteksi:</b> ${objekUtama} <br>
        ğŸ“‚ <b>Kategori:</b> ${kategoriDitemukan} <br>
        â™»ï¸ <b>Jenis Sampah:</b> ${jenisSampah} <br>
        ğŸ“Š <b>Keyakinan AI:</b> ${conf}% 
    `;
}
</script>

</body>
</html>